{% extends 'base.html' %}
{% block title %}ScreenAR Expert{% endblock %}
{% block css %}
<link rel="stylesheet" type="text/css" href="/static/css/main.css">
<link rel="stylesheet" type="text/css" href="/static/css/screenar.css">
{% endblock %}
{% block header %}{% endblock %}
{% block content %}
ScreenAR
<canvas id='correctedcanvas'></canvas>
<video id='video'></video>
<div id='screenarcontainer'>
  <canvas id='sourcecanvas'></canvas>
  <div id='overlay'></div>
</div>
{% endblock %}
{% block js %}
<script src="/static/ext/socket.io/2.2.0/socket.io.js"></script>
<script src="/static/ext/glfx/glfx.js"></script>
<script src="/static/js/webrtc.js"></script>
<script>
window.config = { room: 'fxpal' }

var corners = null;
var fxcanvas = fx.canvas();
var canvas = document.getElementById('sourcecanvas');
var canvasw = 480;
var canvash = 320;
canvas.width = canvasw;
canvas.height = canvash;
var ctx = canvas.getContext('2d');

var correctedcanvas = document.getElementById('correctedcanvas');
correctedcanvas.width = 640;//canvasw;
correctedcanvas.height = 360;//canvash;
var correctedctx = correctedcanvas.getContext('2d');

// setup sample video
var constraints = {
    video: false,
    audio: true
}

var dataChannelCallback = function(data) {
  //console.log('dataChannelCallback data=',data);
  corners = [];data.split(',').forEach(i => corners.push(parseInt(i)));
  //console.log('received corners',corners);
}

var wrtc;
navigator.mediaDevices.getUserMedia(constraints).then(
    function(stream) {
        wrtc = new WebRTCClient({ stream: stream, dataChannel:'ScreenAR', dataChannelCallback: dataChannelCallback, room: config.room });
        wrtc.on('stream', function(id, stream) {
            var video = $('#video')[0]
            video.srcObject = stream;
            video.autoplay = true;
        });
    }
);

function showMark(x,y,text)
{
    let div = document.createElement('div');
    div.className = 'mark';
    div.style.left = x + '%';
    div.style.top = y + '%';
    let w = 20;
    let h = 15;
    div.style.width = w + '%';
    div.style.height = h + '%';
    div.innerHTML = `<span>${text}</span>`;
    div.querySelector('span').style.fontSize = (overlay.offsetHeight / 30) + 'px'
    overlay.appendChild(div);
    setTimeout(function () {div.style.opacity = 1;},0);
}

function drawVideo()
{
  if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight)
  {
    canvasw = video.videoWidth;
    canvash = video.videoHeight;

    console.log('new video width/height=',canvasw,canvash)

    canvas.width = canvasw;
    canvas.height = canvash;

    //correctedcanvas.width = canvasw;
    //correctedcanvas.height = canvash;

    fxcanvas = fx.canvas();
    fxcanvas.width = canvasw;
    fxcanvas.height = canvash;

  }
  //console.log('drawVideo');
  ctx.drawImage(video,0,0,canvasw,canvash);
  if (corners !== null)
  {
    /*ctx.lineWidth = 3;
    ctx.font = '32px Arial';
    ctx.fillStyle = 'blue';
    ctx.strokeStyle = 'red';
    ctx.beginPath();*/
    let sx = canvasw / 1024;
    let sy = canvash / 1024;
    let scaledcorners = [];
    // corners are bl,br,tl,tr
    for (let i=0;i<4;i++)
    {
      scaledcorners.push(corners[2*i] * sx);
      scaledcorners.push(corners[2*i+1] * sy);
    }
    /*ctx.moveTo(scaledcorners[0],scaledcorners[1]);
    ctx.lineTo(scaledcorners[2],scaledcorners[3]);
    ctx.lineTo(scaledcorners[6],scaledcorners[7]);
    ctx.lineTo(scaledcorners[4],scaledcorners[5]);
    ctx.lineTo(scaledcorners[0],scaledcorners[1]);
    ctx.stroke();*/

    /*ctx.fillText('tl',scaledcorners[0],scaledcorners[1]);
    ctx.fillText('tr',scaledcorners[2],scaledcorners[3]);
    ctx.fillText('br',scaledcorners[6],scaledcorners[7]);
    ctx.fillText('bl',scaledcorners[4],scaledcorners[5]);*/
    //detectRedDots(ctx);
    var texture = fxcanvas.texture(canvas);
    let perspectivecorners = [
      scaledcorners[4],scaledcorners[5],
      scaledcorners[6],scaledcorners[7],
      scaledcorners[2],scaledcorners[3],
      scaledcorners[0],scaledcorners[1]];
    fxcanvas.draw(texture).perspective( perspectivecorners, [0,0,canvasw,0,canvasw,canvash,0,canvash] ).update();
    //fxcanvas.draw(texture).perspective( [0,canvash,canvasw,canvash,0,0,canvasw,0], [0,canvash,canvasw,canvash,0,0,canvasw,0] ).update();
    correctedctx.drawImage(fxcanvas,0,0,correctedcanvas.width,correctedcanvas.height);
  }
  window.requestAnimationFrame(drawVideo);
}

/*function detectRedDots(ctx)
{
  let imgData = ctx.getImageData(0,0,canvasw,canvash);
  let data = imgData.data;
  for (let i=0;i<data.length;i+=4)
  {
    if (data[i] >= 200 && data[i+1] < 32 && data[i+2] < 32)
    {
      data[i] = 0xff;
      data[i+1] = 0xff;
      data[i+2] = 0xff;
    }
    else
    {
      data[i] = 0x00;
      data[i+1] = 0x00;
      data[i+2] = 0x00;
    }
  }
  ctx.putImageData(imgData,0,0);
}*/

function sendClick(x,y,text)
{
  if (wrtc && wrtc.sendChannel)
    wrtc.sendChannel.send(`${x},${y},text`);
}

video.addEventListener('loadedmetadata',function (evt) {
  console.log('video loaded');
  drawVideo();
},false);

correctedcanvas.addEventListener('click',function (evt) {
    evt.preventDefault();
    evt.stopPropagation();
    let x = evt.pageX;
    let y = evt.pageY;
    x -= correctedcanvas.offsetLeft;
    y -= correctedcanvas.offsetTop;
    x = (x * 100 / correctedcanvas.offsetWidth) | 0;
    y = (y * 100 / correctedcanvas.offsetHeight) | 0;
    console.log(x,y);
    //showMark(x,y,'Tap');
    sendClick(x,y,'Tap');
});
</script>
{% endblock%}
